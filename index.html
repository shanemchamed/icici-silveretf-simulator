<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver ETF Portfolio Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light Theme Variables */
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #1a1a1a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --highlight-bg: #f8fafc;
            
            /* Brand Colors */
            --icici-color: #e74c3c;
            --nippon-color: #2980b9;
            --total-color: #10b981;
            --premium-color: #8e44ad;
            --silver-color: #7f8c8d;
            --usd-color: #d35400;
            
            --total-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --total-text: #ffffff;
            
            /* UI Elements */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 16px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            /* Dark Theme Overrides */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --input-bg: #0f172a;
            --input-border: #475569;
            --highlight-bg: #2d3b4e;
            
            --icici-color: #ff6b6b;
            --nippon-color: #4fa3d1;
            --total-color: #34d399;
            --premium-color: #a569bd;
            --silver-color: #95a5a6;
            --usd-color: #e67e22;
            
            --total-bg: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            transition: var(--transition);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header & Nav */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(90deg, var(--icici-color), var(--nippon-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .theme-toggle, .debug-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            font-size: 0.9rem;
        }
        .theme-toggle:hover, .debug-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .debug-toggle input { margin: 0; cursor: pointer; }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
            align-items: start;
        }

        .left-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--nippon-color);
        }

        .card h2 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--text-main);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Specific Card Accents */
        .card.icici h2 { border-color: var(--icici-color); }
        .card.nippon h2 { border-color: var(--nippon-color); }
        .card.market h2 { border-color: var(--text-muted); }

        /* Total Summary Card (Premium Look) */
        .card.total-summary {
            background: var(--total-bg);
            color: var(--total-text);
            border: none;
        }
        .card.total-summary h2 {
            border-color: rgba(255,255,255,0.3);
            color: white;
        }
        .card.total-summary .sub-text {
            color: rgba(255,255,255,0.8);
        }
        .card.total-summary .price-display, 
        .card.total-summary .pnl-positive, 
        .card.total-summary .pnl-negative {
            color: white !important;
        }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-group label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-main);
            font-size: 1rem;
            box-sizing: border-box;
            transition: var(--transition);
        }
        input[type="number"]:focus {
            outline: none;
            border-color: var(--nippon-color);
            box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.1);
        }

        input[type="range"] {
            width: 100%;
            margin-top: 8px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--nippon-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Upload Button Styles */
        .upload-area {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-upload {
            display: inline-block;
            background: var(--highlight-bg);
            border: 1px solid var(--nippon-color);
            color: var(--nippon-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            box-sizing: border-box;
        }
        .btn-upload:hover {
            background: var(--nippon-color);
            color: white;
        }
        .btn-reset {
            background: transparent;
            border: 1px solid var(--icici-color);
            color: var(--icici-color);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 5px;
        }

        /* Typography */
        .price-display {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin: 4px 0;
        }
        .sub-text { font-size: 0.8rem; color: var(--text-muted); }

        .pnl-positive { color: var(--total-color); font-weight: bold; }
        .pnl-negative { color: var(--icici-color); font-weight: bold; }

        /* Chart/Table Area */
        .view-container {
            height: 450px;
            position: relative;
            width: 100%;
            overflow-y: auto;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Tabs Styling */
        .analytics-tabs {
            display: flex;
            gap: 5px;
            background: var(--highlight-bg);
            padding: 4px;
            border-radius: 12px;
            overflow-x: auto;
        }
        .analytics-tabs button {
            border: none;
            background: transparent;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        .analytics-tabs button:hover {
            background: rgba(0,0,0,0.05);
        }
        .analytics-tabs button.active {
            background: var(--bg-card);
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
        }

        .view-switch {
            display: flex;
            background: var(--border-color);
            border-radius: 20px;
            padding: 2px;
            gap: 2px;
        }
        .view-switch button {
            border: none;
            background: transparent;
            padding: 6px 16px;
            border-radius: 18px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }
        .view-switch button.active {
            background: var(--bg-card);
            color: var(--text-main);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
        }
        .status-badge.live { background: rgba(16, 185, 129, 0.15); color: var(--total-color); }
        .status-badge.cached { background: rgba(234, 179, 8, 0.15); color: #d97706; }
        .status-badge.static { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .status-badge.uploaded { background: rgba(142, 68, 173, 0.15); color: #8e44ad; }
        .status-badge.error { background: rgba(231, 76, 60, 0.15); color: var(--icici-color); }

        /* Data Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            text-align: right;
            font-weight: 600;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        .data-table th:first-child, .data-table td:first-child {
            text-align: left;
        }
        .data-table tr:hover {
            background-color: var(--highlight-bg);
        }
        .tab-indicator {
            font-size: 0.75em;
            color: var(--text-muted);
            font-weight: normal;
            display: block;
        }
        
        .data-meta {
            background: var(--highlight-bg);
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .data-meta strong { color: var(--text-main); }

        /* Debug Console */
        .debug-console {
            display: none;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 25px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .debug-console.visible {
            display: block;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-time { color: #569cd6; margin-right: 8px; }
        .log-error { color: #f44747; }
        .log-success { color: #6a9955; }
        .log-info { color: #9cdcfe; }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .chart-header { flex-direction: column; align-items: flex-start; }
            .analytics-tabs { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body data-theme="light">

<div class="container">
    
    <div class="app-header">
        <h1>Silver ETF Simulator</h1>
        <div class="header-controls">
            <label class="debug-toggle">
                <input type="checkbox" id="debugToggle" onchange="toggleDebug()"> Debug API
            </label>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">üåô</span> <span id="themeText">Dark Mode</span>
            </button>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <!-- Left Column: Inputs -->
        <div class="left-col">
            
            <!-- Market Factors -->
            <div class="card market">
                <h2>
                    Market Factors
                    <span id="apiStatus" class="status-badge">Init...</span>
                </h2>
                
                <!-- Data Status Details -->
                <div class="data-meta">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>Source: <strong id="dataSourceLabel">...</strong></span>
                        <span id="lastUpdateLabel">...</span>
                    </div>
                    <div id="dataDescLabel" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor:help;" title="">Loading...</div>
                </div>

                <div class="input-group">
                    <label>USD to INR (‚Çπ)</label>
                    <input type="number" id="usdInr" value="91.63" step="0.01" oninput="syncInputs('usdInr', 'usdInrRange')">
                    <input type="range" id="usdInrRange" min="85" max="95" step="0.05" value="91.63" oninput="syncInputs('usdInrRange', 'usdInr')">
                </div>
                <div class="input-group">
                    <label>Int'l Silver ($/oz)</label>
                    <input type="number" id="silverPrice" value="93.53" step="0.01" oninput="syncInputs('silverPrice', 'silverPriceRange')">
                    <input type="range" id="silverPriceRange" min="0" max="150" step="0.1" value="93.53" oninput="syncInputs('silverPriceRange', 'silverPrice')">
                </div>
                
                <!-- Premium Adjustment -->
                <div class="input-group" style="padding-top: 10px; border-top: 1px dashed var(--border-color);">
                    <label>
                        Duty & Premium (%)
                        <span id="premiumDisplay" style="color:var(--premium-color)">1.2%</span>
                    </label>
                    <input type="range" id="premiumRange" min="-20" max="30" step="0.1" value="1.2" oninput="updatePremium()">
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">
                        *Baseline premium for projection
                    </div>
                </div>

                <!-- Updated Upload/Import Section -->
                <div class="upload-area">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-size:0.8rem; font-weight:600; color:var(--text-muted)">Update History:</span>
                        <button onclick="fetchMarketData()" style="background:none; border:none; color:var(--nippon-color); text-decoration:underline; cursor:pointer; font-size:0.8rem;">Refresh API</button>
                    </div>
                    
                    <!-- Trigger to show import options -->
                    <button class="btn-upload" onclick="toggleImportSection()">
                        üìÅ Import / Paste Data
                    </button>

                    <!-- Hidden Import Section -->
                    <div id="importSection" style="display:none; margin-top:10px;">
                        <textarea id="jsonPasteArea" rows="5" placeholder='Paste JSON here: [{"d":"...", ...}]' style="width:100%; font-size:0.8rem; margin-bottom:8px; border-radius:8px; padding:8px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text-main); font-family:monospace; resize:vertical; box-sizing:border-box;"></textarea>
                        
                        <div style="display:flex; gap:8px;">
                            <button class="btn-upload" onclick="handleTextUpload()" style="flex:1; background:var(--nippon-color); color:white;">
                                Load Text
                            </button>
                            <label class="btn-upload" style="flex:1; text-align:center; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                                Upload File
                                <input type="file" id="jsonUpload" accept=".json" style="display:none" onchange="handleFileUpload(this)">
                            </label>
                        </div>
                        <div style="text-align:center; margin-top:5px;">
                            <button class="btn-reset" onclick="toggleImportSection()">Cancel</button>
                        </div>
                    </div>

                    <button id="resetDataBtn" class="btn-reset" onclick="resetToStatic()" style="display:none; width:100%; margin-top:10px;">
                        ‚Ü∫ Reset to Default Data
                    </button>
                </div>
            </div>

            <!-- ICICI Box -->
            <div class="card icici">
                <h2>ICICI Silver ETF</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="price-display" id="iciciPrice" style="color: var(--icici-color)">‚Çπ278.90</div>
                    <div class="sub-text">Current Unit Price</div>
                </div>
                <div class="input-group">
                    <label>Invested (‚Çπ)</label>
                    <input type="number" id="iciciInvested" placeholder="0" oninput="calculatePortfolioAndSave()">
                </div>
                <div class="input-group">
                    <label>Avg Buy Price (‚Çπ)</label>
                    <input type="number" id="iciciAvg" placeholder="0" step="0.01" oninput="calculatePortfolioAndSave()">
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:15px; padding-top:10px; border-top:1px solid var(--border-color);">
                    <span class="sub-text">Profit/Loss</span>
                    <span id="iciciPnl">‚Çπ0</span>
                </div>
            </div>

            <!-- Nippon Box -->
            <div class="card nippon">
                <h2>Nippon Silver ETF</h2>
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="price-display" id="nipponPrice" style="color: var(--nippon-color)">‚Çπ276.30</div>
                    <div class="sub-text">Current Unit Price</div>
                </div>
                <div class="input-group">
                    <label>Invested (‚Çπ)</label>
                    <input type="number" id="nipponInvested" placeholder="0" oninput="calculatePortfolioAndSave()">
                </div>
                <div class="input-group">
                    <label>Avg Buy Price (‚Çπ)</label>
                    <input type="number" id="nipponAvg" placeholder="0" step="0.01" oninput="calculatePortfolioAndSave()">
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:15px; padding-top:10px; border-top:1px solid var(--border-color);">
                    <span class="sub-text">Profit/Loss</span>
                    <span id="nipponPnl">‚Çπ0</span>
                </div>
            </div>

        </div>

        <!-- Right Column: Graph & Summary -->
        <div class="right-col">
            
            <!-- Total Summary Card -->
            <div class="card total-summary" style="margin-bottom: 24px;">
                <h2>Total Portfolio Value</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div class="sub-text">Invested</div>
                        <div id="totalInvested" style="font-weight:bold; font-size:1.1rem;">‚Çπ0</div>
                    </div>
                    <div>
                        <div class="sub-text">Current Value</div>
                        <div id="totalValue" style="font-weight:800; font-size: 1.4rem;">‚Çπ0</div>
                    </div>
                    <div>
                        <div class="sub-text">Total P&L</div>
                        <div id="totalPnl" style="font-weight:bold; font-size:1.1rem;">‚Çπ0</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Card -->
            <div class="card">
                <div class="chart-header">
                    <!-- Tabs -->
                    <div class="analytics-tabs">
                        <button class="active" onclick="setChartType('portfolio', this)">Portfolio</button>
                        <button onclick="setChartType('premium', this)">Premium %</button>
                        <button onclick="setChartType('silver', this)">Int'l Silver</button>
                        <button onclick="setChartType('usd', this)">USD/INR</button>
                    </div>

                    <div style="flex-grow:1"></div>

                    <!-- View Switcher -->
                    <div class="view-switch">
                        <button class="active" onclick="switchView('chart', this)">Graph</button>
                        <button onclick="switchView('table', this)">Table</button>
                    </div>
                </div>
                
                <div class="view-container">
                    <!-- Canvas Layer -->
                    <div id="canvasWrapper" style="width:100%; height:100%;">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                    <!-- Table Layer (Hidden by default) -->
                    <div id="tableWrapper" style="display:none; width:100%;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Silver $</th>
                                    <th>USD ‚Çπ</th>
                                    <th>Fair Val ‚Çπ <div class="tab-indicator">Base/g</div></th>
                                    <th>ICICI ‚Çπ</th>
                                    <th>Prem %</th>
                                    <th>Nippon ‚Çπ</th>
                                    <th>Prem %</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                     <div style="font-size:0.75rem; color:var(--text-muted);" id="graphControls">
                        <label class="custom-checkbox" style="color:var(--icici-color); display:inline-flex; margin-right:10px;">
                            <input type="checkbox" id="showIcici" checked onchange="toggleDataset(0)"> ICICI
                        </label>
                        <label class="custom-checkbox" style="color:var(--nippon-color); display:inline-flex; margin-right:10px;">
                            <input type="checkbox" id="showNippon" checked onchange="toggleDataset(1)"> Nippon
                        </label>
                        <label class="custom-checkbox" style="color:var(--total-color); display:inline-flex;">
                            <input type="checkbox" id="showTotal" checked onchange="toggleDataset(2)"> Total
                        </label>
                     </div>
                     <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:0.8rem; font-weight:600; color:var(--text-muted);">History Days:</span>
                        <input type="range" min="5" max="20" value="14" id="daysRange" style="width:100px;" oninput="updateChartDisplay()">
                    </div>
                </div>
            </div>

            <!-- DEBUG CONSOLE -->
            <div id="debugConsole" class="debug-console">
                <div style="border-bottom:1px solid #444; margin-bottom:5px; padding-bottom:5px; display:flex; justify-content:space-between;">
                    <strong>API Debug Console</strong>
                    <button onclick="document.getElementById('debugLog').innerHTML=''" style="background:none; border:none; color:#888; cursor:pointer;">Clear</button>
                </div>
                <div id="debugLog"></div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Theme Logic ---
    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('themeIcon');
        const text = document.getElementById('themeText');
        const current = body.getAttribute('data-theme');
        
        if (current === 'light') {
            body.setAttribute('data-theme', 'dark');
            icon.innerText = '‚òÄÔ∏è';
            text.innerText = 'Light Mode';
            localStorage.setItem('etf_theme', 'dark');
        } else {
            body.setAttribute('data-theme', 'light');
            icon.innerText = 'üåô';
            text.innerText = 'Dark Mode';
            localStorage.setItem('etf_theme', 'light');
        }
        updateChartTheme();
    }

    function initTheme() {
        const saved = localStorage.getItem('etf_theme') || 'light';
        const body = document.body;
        body.setAttribute('data-theme', saved);
        if(saved === 'dark') {
            document.getElementById('themeIcon').innerText = '‚òÄÔ∏è';
            document.getElementById('themeText').innerText = 'Light Mode';
        }
    }

    // --- DEBUG LOGIC ---
    let debugMode = false;
    function toggleDebug() {
        debugMode = document.getElementById('debugToggle').checked;
        const consoleEl = document.getElementById('debugConsole');
        if(debugMode) {
            consoleEl.classList.add('visible');
            logDebug("Debug Mode Enabled", "info");
        } else {
            consoleEl.classList.remove('visible');
        }
    }

    function logDebug(msg, type = "info") {
        if(!debugMode) return;
        const log = document.getElementById('debugLog');
        const time = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${msg}</span>`;
        log.appendChild(div);
        const container = document.getElementById('debugConsole');
        container.scrollTop = container.scrollHeight;
    }

    // --- Configuration ---
    const STORAGE_KEY = 'silver_portfolio_v29'; // Updated version key
    const DATA_STORAGE_KEY = 'silver_history_data';
    const OZ_TO_KG = 32.1507;
    const KG_TO_GRAM = 1000;
    
    // Default calibration if offline
    let globalPremiumPercent = 1.2;
    let currentChartType = 'portfolio';

    // --- Exact Data Provided by User (Default Historical Record) ---
    // Changed to 'let' to allow overwriting via Upload
	let staticData = [
		{ d: "23-Jan-26", ag: 100.64, usd: 91.63, ic: 306.55, nip: 292.73 },
		{ d: "22-Jan-26", ag: 93.53, usd: 91.63, ic: 278.9, nip: 276.3 },
		{ d: "21-Jan-26", ag: 93.17, usd: 91.65, ic: 321.5, nip: 308.0 },
		{ d: "20-Jan-26", ag: 94.37, usd: 91.58, ic: 313.8, nip: 297.6 },
		{ d: "19-Jan-26", ag: 95.87, usd: 91.50, ic: 295.0, nip: 282.9 },
		{ d: "16-Jan-26", ag: 90.09, usd: 90.33, ic: 281.7, nip: 269.4 },
		{ d: "14-Jan-26", ag: 90.09, usd: 90.61, ic: 274.3, nip: 262.8 },
		{ d: "13-Jan-26", ag: 90.28, usd: 90.59, ic: 260.8, nip: 249.5 },
		{ d: "12-Jan-26", ag: 89.95, usd: 90.53, ic: 254.1, nip: 243.4 },
		{ d: "09-Jan-26", ag: 80.09, usd: 90.53, ic: 240.4, nip: 230.4 },
		{ d: "08-Jan-26", ag: 80.09, usd: 90.13, ic: 234.1, nip: 223.5 },
		{ d: "07-Jan-26", ag: 80.09, usd: 90.25, ic: 244.4, nip: 234.4 },
		{ d: "06-Jan-26", ag: 80.09, usd: 90.25, ic: 241.7, nip: 231.7 },
		{ d: "05-Jan-26", ag: 76.13, usd: 90.25, ic: 225.5, nip: 225.5 },
		{ d: "02-Jan-26", ag: 72.05, usd: 90.25, ic: 218.0, nip: 221.9 },
		{ d: "31-Dec-25", ag: 76.23, usd: 89.98, ic: 223.0, nip: 215.4 },
		{ d: "30-Dec-25", ag: 75.20, usd: 89.76, ic: 220.0, nip: 218.2 },
		{ d: "26-Dec-25", ag: 79.18, usd: 89.78, ic: 229.0, nip: 219.9 },
		{ d: "24-Dec-25", ag: 71.80, usd: 89.83, ic: 210.0, nip: 209.2 },
		{ d: "23-Dec-25", ag: 71.80, usd: 89.48, ic: 205.0, nip: 201.8 },
		{ d: "22-Dec-25", ag: 69.12, usd: 89.66, ic: 202.0, nip: 200.0 }
	];
    // Keep a copy of default for resetting
    const defaultStaticData = JSON.parse(JSON.stringify(staticData));

    let sortedStatic;
    let defaultHistoryData;
    let historyData;

    // --- Elements ---
    const usdInput = document.getElementById('usdInr');
    const silverInput = document.getElementById('silverPrice');
    const premiumRange = document.getElementById('premiumRange');
    const premiumDisplay = document.getElementById('premiumDisplay');
    
    const iciciInv = document.getElementById('iciciInvested');
    const iciciAvg = document.getElementById('iciciAvg');
    const iciciPriceEl = document.getElementById('iciciPrice');
    const iciciPnlEl = document.getElementById('iciciPnl');
    const nipponInv = document.getElementById('nipponInvested');
    const nipponAvg = document.getElementById('nipponAvg');
    const nipponPriceEl = document.getElementById('nipponPrice');
    const nipponPnlEl = document.getElementById('nipponPnl');
    const totalInvEl = document.getElementById('totalInvested');
    const totalValEl = document.getElementById('totalValue');
    const totalPnlEl = document.getElementById('totalPnl');
    
    const dataSourceLabel = document.getElementById('dataSourceLabel');
    const lastUpdateLabel = document.getElementById('lastUpdateLabel');
    const dataDescLabel = document.getElementById('dataDescLabel');
    const apiStatus = document.getElementById('apiStatus');
    const resetBtn = document.getElementById('resetDataBtn');

    function prepareData() {
        sortedStatic = [...staticData].reverse();
        defaultHistoryData = {
            dates: sortedStatic.map(d => d.d),
            icici: sortedStatic.map(d => d.ic),
            nippon: sortedStatic.map(d => d.nip),
            silver: sortedStatic.map(d => d.ag),
            usd: sortedStatic.map(d => d.usd)
        };
        historyData = JSON.parse(JSON.stringify(defaultHistoryData));
    }

    function updateStatusUI(source, time, desc, statusClass) {
        dataSourceLabel.innerText = source;
        lastUpdateLabel.innerText = time;
        dataDescLabel.innerText = desc;
        dataDescLabel.title = desc; 
        
        let label = "Static";
        if(source === "Live API") label = "Live";
        else if(source === "Uploaded Data") label = "File";
        else if(source === "Cached Data") label = "Cached";

        apiStatus.innerText = label;
        apiStatus.className = `status-badge ${statusClass}`;
    }

    // --- File & Paste Upload Logic ---
    window.toggleImportSection = function() {
        const sec = document.getElementById('importSection');
        sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    }

    function validateAndLoadJSON(json) {
        if(Array.isArray(json) && json.length > 0 && json[0].d && json[0].ag) {
            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(json));
            logDebug("Data loaded. Reloading...", "success");
            location.reload();
        } else {
            alert("Invalid JSON format. Expected array of objects with 'd', 'ag', 'usd', 'ic', 'nip' keys.");
        }
    }

    window.handleFileUpload = function(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                validateAndLoadJSON(JSON.parse(e.target.result));
            } catch(err) {
                alert("Error parsing JSON file: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    window.handleTextUpload = function() {
        const text = document.getElementById('jsonPasteArea').value;
        if(!text) {
            alert("Please paste JSON data first.");
            return;
        }
        try {
            // Try standard JSON first
            validateAndLoadJSON(JSON.parse(text));
        } catch(err) {
            // Fallback: Try to parse as JavaScript Object (Relaxed JSON)
            try {
                const looseJson = new Function("return " + text)();
                validateAndLoadJSON(looseJson);
            } catch (e2) {
                alert("Error parsing text. Ensure it is valid JSON or a JavaScript Array.\n\nDetails: " + err.message);
            }
        }
    }

    window.resetToStatic = function() {
        if(confirm("Are you sure you want to delete uploaded data and reset to defaults?")) {
            localStorage.removeItem(DATA_STORAGE_KEY);
            location.reload();
        }
    }

    // --- View Switching ---
    window.switchView = function(view, btn) {
        const btns = btn.parentNode.querySelectorAll('button');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const chartWrapper = document.getElementById('canvasWrapper');
        const tableWrapper = document.getElementById('tableWrapper');

        if(view === 'chart') {
            chartWrapper.style.display = 'block';
            tableWrapper.style.display = 'none';
        } else {
            chartWrapper.style.display = 'none';
            tableWrapper.style.display = 'block';
            renderTable();
        }
    }

    window.setChartType = function(type, btn) {
        const btns = btn.parentNode.querySelectorAll('button');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentChartType = type;
        
        if(document.getElementById('canvasWrapper').style.display === 'none') {
            window.switchView('chart', document.querySelector('.view-switch button:first-child'));
        }
        updateChartDisplay();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        const daysToShow = parseInt(document.getElementById('daysRange').value);
        const startIndex = Math.max(0, historyData.dates.length - daysToShow);
        
        for(let i = historyData.dates.length - 1; i >= startIndex; i--) {
            const date = historyData.dates[i];
            const silver = historyData.silver[i];
            const usd = historyData.usd[i];
            const icici = historyData.icici[i];
            const nippon = historyData.nippon[i];
            
            const fairValue = (silver * OZ_TO_KG * usd) / KG_TO_GRAM;
            const iciciPrem = ((icici - fairValue) / fairValue) * 100;
            const nipponPrem = ((nippon - fairValue) / fairValue) * 100;
            
            const icColor = iciciPrem >= 0 ? 'var(--total-color)' : '#e74c3c';
            const niColor = nipponPrem >= 0 ? 'var(--total-color)' : '#e74c3c';

            const row = `
                <tr>
                    <td style="text-align:left;">${date}</td>
                    <td>$${silver.toFixed(2)}</td>
                    <td>‚Çπ${usd.toFixed(2)}</td>
                    <td style="color:var(--text-muted)">‚Çπ${fairValue.toFixed(2)}</td>
                    <td style="font-weight:bold; color:var(--icici-color)">‚Çπ${icici.toFixed(1)}</td>
                    <td style="font-weight:bold; color:${icColor}">${iciciPrem.toFixed(2)}%</td>
                    <td style="font-weight:bold; color:var(--nippon-color)">‚Çπ${nippon.toFixed(1)}</td>
                    <td style="font-weight:bold; color:${niColor}">${nipponPrem.toFixed(2)}%</td>
                </tr>
            `;
            tbody.innerHTML += row;
        }
    }

    let chartInstance;
    const ctx = document.getElementById('portfolioChart').getContext('2d');

    function init() {
        initTheme();
        
        // 1. Check for Uploaded Data
        const customData = localStorage.getItem(DATA_STORAGE_KEY);
        if(customData) {
            try {
                staticData = JSON.parse(customData);
                resetBtn.style.display = 'inline-block';
                updateStatusUI("Uploaded Data", "From Local Storage", "Using your custom JSON file.", "uploaded");
            } catch(e) {
                console.error("Failed to load custom data", e);
            }
        } else {
             // 2. Default Static
            updateStatusUI("Static Data", "Validated", "Verified historical data (Investing.com)", "static");
        }

        prepareData();
        loadState(); // Load saved user inputs
        initChart();
        calculatePortfolioAndSave(); 
    }

    // --- SAVE / LOAD STATE (Enhanced) ---
    function saveState() {
        const data = {
            iciciInv: iciciInv.value, iciciAvg: iciciAvg.value,
            nipponInv: nipponInv.value, nipponAvg: nipponAvg.value,
            premium: premiumRange.value,
            usd: usdInput.value,
            silver: silverInput.value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        // logDebug("Auto-saved state", "info");
    }

    function loadState() {
        const stored = localStorage.getItem(STORAGE_KEY);
        
        // Default latest values from static data
        const latest = staticData[0];
        let loadedUsd = latest.usd;
        let loadedSilver = latest.ag;

        if(stored) {
            const data = JSON.parse(stored);
            if(data.iciciInv) iciciInv.value = data.iciciInv;
            if(data.iciciAvg) iciciAvg.value = data.iciciAvg;
            if(data.nipponInv) nipponInv.value = data.nipponInv;
            if(data.nipponAvg) nipponAvg.value = data.nipponAvg;
            
            if(data.premium) { 
                premiumRange.value = data.premium; 
                globalPremiumPercent = parseFloat(data.premium);
                premiumDisplay.innerText = data.premium + "%";
            }
            
            // Overwrite with user saved values if they exist
            if(data.usd) loadedUsd = data.usd;
            if(data.silver) loadedSilver = data.silver;
        }
        
        // Apply values to inputs
        usdInput.value = parseFloat(loadedUsd).toFixed(2);
        document.getElementById('usdInrRange').value = loadedUsd;
        
        silverInput.value = parseFloat(loadedSilver).toFixed(2);
        document.getElementById('silverPriceRange').value = loadedSilver;
    }

    // Combined function to calculate AND save state (for inputs)
    window.calculatePortfolioAndSave = function() {
        calculatePortfolio();
        saveState();
    }

    window.syncInputs = function(src, dest) {
        document.getElementById(dest).value = document.getElementById(src).value;
        calculatePortfolioAndSave();
    }
    
    window.updatePremium = function() {
        globalPremiumPercent = parseFloat(premiumRange.value);
        premiumDisplay.innerText = globalPremiumPercent.toFixed(1) + "%";
        calculatePortfolioAndSave();
    }

    function calculatePortfolio() {
        const usd = parseFloat(usdInput.value) || 0;
        const silver = parseFloat(silverInput.value) || 0;

        // Current Forecast Logic (for the top cards)
        const basePrice = (silver * OZ_TO_KG * usd) / KG_TO_GRAM;
        const currentIciciPrice = basePrice * (1 + (globalPremiumPercent/100));
        const currentNipponPrice = currentIciciPrice * 0.99; // Simple spread logic for *forecast* only

        iciciPriceEl.innerText = "‚Çπ" + currentIciciPrice.toFixed(2);
        nipponPriceEl.innerText = "‚Çπ" + currentNipponPrice.toFixed(2);

        const iInv = parseFloat(iciciInv.value) || 0;
        const iAvg = parseFloat(iciciAvg.value) || 0;
        let iUnits = 0, iVal = 0, iPnl = 0;
        if(iInv > 0 && iAvg > 0) {
            iUnits = iInv / iAvg;
            iVal = iUnits * currentIciciPrice;
            iPnl = iVal - iInv;
        }
        formatPnl(iciciPnlEl, iPnl, iInv);

        const nInv = parseFloat(nipponInv.value) || 0;
        const nAvg = parseFloat(nipponAvg.value) || 0;
        let nUnits = 0, nVal = 0, nPnl = 0;
        if(nInv > 0 && nAvg > 0) {
            nUnits = nInv / nAvg;
            nVal = nUnits * currentNipponPrice;
            nPnl = nVal - nInv;
        }
        formatPnl(nipponPnlEl, nPnl, nInv);

        const tInv = iInv + nInv;
        const tVal = iVal + nVal;
        const tPnl = tVal - tInv;

        totalInvEl.innerText = "‚Çπ" + tInv.toLocaleString('en-IN', {maximumFractionDigits:0});
        totalValEl.innerText = "‚Çπ" + tVal.toLocaleString('en-IN', {maximumFractionDigits:0});
        formatPnl(totalPnlEl, tPnl, tInv);

        updateChartData(currentIciciPrice, currentNipponPrice, iUnits, nUnits);
        if(document.getElementById('tableWrapper').style.display !== 'none') {
            renderTable(); 
        }
    }

    function formatPnl(el, amount, base) {
        const pct = base > 0 ? (amount/base)*100 : 0;
        const sign = amount >= 0 ? "+" : "";
        el.innerText = `${sign}‚Çπ${Math.abs(amount).toFixed(0)} (${sign}${pct.toFixed(2)}%)`;
        el.className = amount >= 0 ? 'pnl-positive' : 'pnl-negative';
    }

    function initChart() {
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] }, 
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: true, position:'top' } },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: false, title: { display: true, text: 'Price' } },
                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Total Value (‚Çπ)' } }
                }
            }
        });
    }

    function updateChartTheme() {
        if(!chartInstance) return;
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#94a3b8' : '#64748b';
        const gridColor = isDark ? '#334155' : '#e2e8f0';

        if(chartInstance.options.scales.x) chartInstance.options.scales.x.ticks.color = textColor;
        if(chartInstance.options.scales.y) {
            chartInstance.options.scales.y.ticks.color = textColor;
            chartInstance.options.scales.y.grid.color = gridColor;
            chartInstance.options.scales.y.title.color = textColor;
        }
        if(chartInstance.options.scales.y1) {
            chartInstance.options.scales.y1.ticks.color = textColor;
            chartInstance.options.scales.y1.title.color = textColor;
        }
        
        const ds = chartInstance.data.datasets;
        if (currentChartType === 'portfolio' && ds.length >= 3) {
            ds[0].borderColor = isDark ? '#ff6b6b' : '#e74c3c';
            ds[1].borderColor = isDark ? '#4fa3d1' : '#2980b9';
            ds[2].borderColor = isDark ? '#34d399' : '#10b981';
        } else if (currentChartType === 'premium' && ds.length > 0) {
            ds[0].borderColor = isDark ? '#a569bd' : '#8e44ad';
        } else if (currentChartType === 'silver' && ds.length > 0) {
            ds[0].borderColor = isDark ? '#95a5a6' : '#7f8c8d';
        } else if (currentChartType === 'usd' && ds.length > 0) {
            ds[0].borderColor = isDark ? '#e67e22' : '#d35400';
        }

        chartInstance.update();
    }

    window.toggleDataset = function(index) {
        if(chartInstance && chartInstance.data.datasets[index]) {
            const isChecked = document.querySelectorAll('#graphControls input[type="checkbox"]')[index].checked;
            chartInstance.data.datasets[index].hidden = !isChecked;
            chartInstance.update();
        }
    }

    function updateChartData(currIcici, currNippon, iUnits, nUnits) {
        const daysToShow = parseInt(document.getElementById('daysRange').value);
        const sliceStart = Math.max(0, historyData.dates.length - daysToShow);
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        
        const labels = historyData.dates.slice(sliceStart);
        const dIcici = historyData.icici.slice(sliceStart);
        const dNippon = historyData.nippon.slice(sliceStart);
        const dSilver = historyData.silver.slice(sliceStart);
        const dUsd = historyData.usd.slice(sliceStart);

        let datasets = [];
        let yLabel = 'Price (‚Çπ)';
        
        if(currentChartType === 'portfolio') {
            labels.push('Forecast');
            dIcici.push(currIcici);
            dNippon.push(currNippon);
            
            const dTotal = dIcici.map((pI, idx) => {
                const pN = dNippon[idx] || 0;
                return (pI * iUnits) + (pN * nUnits);
            });

            datasets = [
                { label: 'ICICI (‚Çπ)', data: dIcici, borderColor: isDark ? '#ff6b6b' : '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill:true, tension:0.3 },
                { label: 'Nippon (‚Çπ)', data: dNippon, borderColor: isDark ? '#4fa3d1' : '#2980b9', backgroundColor: 'rgba(41,128,185,0.1)', fill:true, tension:0.3 },
                { label: 'Total Value (‚Çπ)', data: dTotal, borderColor: isDark ? '#34d399' : '#10b981', borderDash:[5,5], tension:0.3, yAxisID: 'y1' }
            ];
            yLabel = 'Unit Price (‚Çπ)';
            if(chartInstance.options.scales.y1) chartInstance.options.scales.y1.display = true;
        } else if (currentChartType === 'premium') {
            const dPremiumIcici = dIcici.map((ic, idx) => {
                const ag = dSilver[idx] || 0;
                const us = dUsd[idx] || 0;
                const base = (ag * OZ_TO_KG * us) / KG_TO_GRAM;
                return base > 0 ? ((ic - base) / base) * 100 : 0;
            });
            dPremiumIcici.push(globalPremiumPercent); // Push forecast
            
            const dPremiumNippon = dNippon.map((nip, idx) => {
                const ag = dSilver[idx] || 0;
                const us = dUsd[idx] || 0;
                const base = (ag * OZ_TO_KG * us) / KG_TO_GRAM;
                return base > 0 ? ((nip - base) / base) * 100 : 0;
            });
            dPremiumNippon.push(globalPremiumPercent); // Push forecast

            labels.push('Forecast');

            datasets = [
                { label: 'ICICI Premium %', data: dPremiumIcici, borderColor: isDark ? '#ff6b6b' : '#e74c3c', fill: false, tension: 0.3 },
                { label: 'Nippon Premium %', data: dPremiumNippon, borderColor: isDark ? '#4fa3d1' : '#2980b9', fill: false, tension: 0.3 }
            ];
            yLabel = 'Premium (%)';
            if(chartInstance.options.scales.y1) chartInstance.options.scales.y1.display = false;
        } else if (currentChartType === 'silver') {
            dSilver.push(parseFloat(silverInput.value));
            labels.push('Forecast');
            
            datasets = [{
                label: 'Silver Spot ($)',
                data: dSilver,
                borderColor: isDark ? '#95a5a6' : '#7f8c8d',
                tension: 0.3
            }];
            yLabel = 'Price ($)';
            if(chartInstance.options.scales.y1) chartInstance.options.scales.y1.display = false;
        } else if (currentChartType === 'usd') {
            dUsd.push(parseFloat(usdInput.value));
            labels.push('Forecast');
            
            datasets = [{
                label: 'USD/INR (‚Çπ)',
                data: dUsd,
                borderColor: isDark ? '#e67e22' : '#d35400',
                tension: 0.3
            }];
            yLabel = 'Exchange Rate (‚Çπ)';
            if(chartInstance.options.scales.y1) chartInstance.options.scales.y1.display = false;
        }

        chartInstance.data.labels = labels;
        chartInstance.data.datasets = datasets;
        if(chartInstance.options.scales.y) chartInstance.options.scales.y.title.text = yLabel;
        
        const controls = document.getElementById('graphControls');
        if(currentChartType === 'portfolio') {
            controls.style.visibility = 'visible';
            const checks = document.querySelectorAll('#graphControls input[type="checkbox"]');
            chartInstance.data.datasets.forEach((ds, i) => { if(checks[i]) ds.hidden = !checks[i].checked; });
        } else {
            controls.style.visibility = 'hidden';
        }

        chartInstance.update();
    }

    async function fetchWithFallback(url) {
        // Expanded Proxy List for better reliability
        const proxies = [
            u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`, 
            u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
            u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            u => `https://thingproxy.freeboard.io/fetch/${u}`
        ];
        
        let errorLog = [];
        
        for(let i=0; i<proxies.length; i++) {
            const p = proxies[i];
            try {
                logDebug(`Attempting Proxy ${i+1}: ${p(url)}`, "info");
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); 
                
                const proxyUrl = p(url);
                const res = await fetch(proxyUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if(res.ok) {
                    const text = await res.text();
                    try {
                        const json = JSON.parse(text);
                        // Handle AllOrigins specific wrapper
                        if (json.contents) {
                            try {
                                const inner = JSON.parse(json.contents);
                                if (inner.chart && inner.chart.result) return inner;
                            } catch(e) {
                                // contents might be raw string
                            }
                        }
                        // Standard Yahoo JSON validation
                        if(json.chart && json.chart.result && json.chart.result.length > 0) {
                            return json;
                        }
                    } catch(parseErr) {
                        logDebug(`Proxy ${i+1} JSON Parse Error: ${parseErr.message}`, "error");
                    }
                }
                errorLog.push(`Proxy ${i+1}: Invalid Response (HTTP ${res.status})`);
                logDebug(`Proxy ${i+1} Failed: HTTP ${res.status}`, "error");
            } catch(e) {
                const reason = e.name === 'AbortError' ? 'Timeout' : e.message;
                errorLog.push(`Proxy ${i+1}: ${reason}`);
                logDebug(`Proxy ${i+1} Exception: ${reason}`, "error");
            }
        }
        throw new Error("All proxies failed. " + errorLog.join(", "));
    }

    window.fetchMarketData = async function() {
        const statusText = document.getElementById('apiStatus');
        updateStatusUI("Updating...", "...", "Attempting to fetch live market data...", "live");
        logDebug("Starting Fetch...", "info");
        
        const ts = Date.now();
        // Use query2 to potentially avoid blocks
        const base = "https://query2.finance.yahoo.com/v8/finance/chart/";
        // Changed range to 1mo to get full history for the table
        const params = "?interval=1d&range=5d&_=" + ts; 

        // 1. Live USD (Frankfurter)
        let liveUsd = null;
        try {
            const usdRes = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
            const usdData = await usdRes.json();
            if(usdData?.rates?.INR) {
                liveUsd = usdData.rates.INR;
                usdInput.value = liveUsd.toFixed(2);
                document.getElementById('usdInrRange').value = liveUsd;
                saveState(); // SAVE NEW USD
                logDebug(`USD Fetch Success: ‚Çπ${liveUsd}`, "success");
            }
        } catch(e) { 
            console.warn("USD fetch failed"); 
            logDebug("USD Fetch Failed", "error");
        }

        // 2. Live Silver (Yahoo via proxy)
        // Fallback Logic: Try Silver Spot first, then Futures if needed
        let silverData = null;
        try {
            silverData = await fetchWithFallback(`${base}XAGUSD=X${params}`);
        } catch(e) {
            logDebug("Spot Silver Fetch Failed, trying Futures...", "info");
            try {
                silverData = await fetchWithFallback(`${base}SI=F${params}`);
            } catch(e2) {
                 logDebug("Futures Fetch Failed too.", "error");
            }
        }

        if(silverData?.chart?.result?.[0]?.meta?.regularMarketPrice) {
            const liveSilver = silverData.chart.result[0].meta.regularMarketPrice;
            silverInput.value = liveSilver.toFixed(2);
            document.getElementById('silverPriceRange').value = liveSilver;
            saveState(); // SAVE NEW SILVER
            
            logDebug(`Silver Fetch Success: $${liveSilver}`, "success");
            
            const todayStr = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' }).replace(/ /g, '-');
            
            // Only update or append the "Live" data point at the end of the history array
            // Do NOT touch the previous static historical data.
            const lastDate = historyData.dates[historyData.dates.length-1];
            
            const currentUsdVal = liveUsd || parseFloat(usdInput.value);
            const base = (liveSilver * OZ_TO_KG * currentUsdVal) / KG_TO_GRAM;
            const currentPrem = parseFloat(premiumRange.value);
            
            const estIcici = base * (1 + (currentPrem/100));
            const estNippon = estIcici * 0.99; // Simple ratio for forecast

            if(lastDate.indexOf("Live") === -1 && lastDate !== todayStr) {
                // New Day: Append
                historyData.dates.push(todayStr + " (Live)");
                historyData.silver.push(liveSilver);
                historyData.usd.push(currentUsdVal);
                historyData.icici.push(estIcici);
                historyData.nippon.push(estNippon);
            } else {
                // Update Today's point
                const idx = historyData.dates.length - 1;
                historyData.dates[idx] = todayStr + " (Live)"; 
                historyData.silver[idx] = liveSilver;
                historyData.usd[idx] = currentUsdVal;
                historyData.icici[idx] = estIcici;
                historyData.nippon[idx] = estNippon;
            }
            
            updateStatusUI("Live API", new Date().toLocaleTimeString(), "Yahoo Finance (Silver) & Frankfurter (USD)", "live");
        } else {
             updateStatusUI("Offline Mode", new Date().toLocaleTimeString(), "Using accurate internal data.", "error");
             logDebug("Fetch failed: No valid Silver data found", "error");
        }

        calculatePortfolioAndSave();
    }

    init();

</script>

</body>
</html>
