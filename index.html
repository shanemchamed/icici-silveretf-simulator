<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICICI Silver ETF Simulator & Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #c0392b;
            --secondary: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --silver: #bdc3c7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        /* Simulator Section */
        .simulator-box {
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            padding: 25px;
            border-radius: 12px;
        }

        .simulator-box h2 {
            margin-top: 0;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            font-size: 0.5em;
            background: #eee;
            padding: 4px 8px;
            border-radius: 10px;
            color: #666;
            font-weight: normal;
        }
        .status-badge.live {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.partial {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .input-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box; 
        }

        .input-group input[type="range"] {
            width: 100%;
            margin-top: 8px;
            accent-color: var(--primary);
        }

        .result-box {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 25px;
            border: 1px solid #dcdcdc;
        }

        .result-box h3 {
            margin: 0;
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .price-display {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .sub-text {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        /* Chart Section */
        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            height: 500px;
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .days-control {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #eee;
        }

        .btn {
            padding: 8px 16px;
            background: var(--light);
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn:hover:not(.active) {
            background: #e0e0e0;
        }

        .canvas-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
        }

        .refresh-btn {
            font-size: 0.8em;
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-layout { grid-template-columns: 1fr; }
            .chart-box { height: 400px; }
            .chart-header { flexDirection: column-reverse; alignItems: flex-start; }
            .chart-controls { width: 100%; justifyContent: space-between; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ICICI Silver ETF Simulator</h1>

    <div class="grid-layout">
        
        <!-- Left Column: Inputs -->
        <div class="simulator-box">
            <h2>
                Predict Price 
                <span id="apiStatus" class="status-badge">Init...</span>
            </h2>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                <span id="sourceText">Connecting to market...</span>
                <button class="refresh-btn" onclick="fetchMarketData()">Retry</button>
            </p>

            <div class="input-group">
                <label for="usdInr">USD to INR Rate (₹)</label>
                <input type="number" id="usdInr" value="90.28" step="0.01">
                <input type="range" id="usdInrRange" min="85" max="95" step="0.05" value="90.28">
            </div>

            <div class="input-group">
                <label for="silverPrice">Int'l Silver Price ($/oz)</label>
                <input type="number" id="silverPrice" value="76.67" step="0.01">
                <input type="range" id="silverPriceRange" min="60" max="90" step="0.1" value="76.67">
            </div>

            <div class="result-box">
                <h3>Estimated ETF Price</h3>
                <div class="price-display" id="calculatedPrice">₹...</div>
                <div class="sub-text">Per Unit (Approx 1g)</div>
                <div style="margin-top:10px; font-size: 0.8em; color:#999;">
                    *Logic: (Silver$ × 32.15 × USD₹ / 1000) × 5.5% Premium
                </div>
            </div>
        </div>

        <!-- Right Column: Graph -->
        <div class="chart-box">
            <div class="chart-header">
                <div class="days-control">
                    <label for="daysRange">History:</label>
                    <input type="range" id="daysRange" min="5" max="25" step="1" value="14" style="width: 100px; accent-color: #7f8c8d;">
                    <span id="daysDisplay" style="min-width: 60px;">14 Days</span>
                </div>
                <div class="chart-controls">
                    <button class="btn active" onclick="updateChartDataset('etf')">ETF</button>
                    <button class="btn" onclick="updateChartDataset('silver')">Silver ($)</button>
                    <button class="btn" onclick="updateChartDataset('usd')">USD/INR</button>
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="silverChart"></canvas>
            </div>
        </div>

    </div>
</div>

<script>
    // --- Data Management ---
    // Fallback Data (Last known successful values - Dec 2025/Jan 2026)
    const fallbackHistory = {
        dates: ["Dec 23", "Dec 24", "Dec 26", "Dec 29", "Dec 30", "Dec 31", "Jan 01", "Jan 02", "Jan 05", "Jan 06", "Jan 07", "Jan 08", "Jan 09"],
        etf: [210.38, 217.94, 229.73, 226.25, 226.67, 225.12, 224.95, 231.68, 235.63, 241.68, 244.42, 234.08, 240.40],
        silver: [71.21, 71.97, 77.32, 72.31, 76.23, 70.46, 71.30, 72.05, 76.13, 80.09, 78.46, 75.86, 76.67],
        usd: [89.51, 89.83, 89.83, 89.90, 89.77, 89.96, 89.96, 90.01, 90.23, 90.17, 89.86, 89.91, 90.28]
    };

    // Main Data Container
    let fullHistory = JSON.parse(JSON.stringify(fallbackHistory));

    // Constants
    const OZ_TO_KG = 32.1507;
    const KG_TO_GRAM = 1000;
    const PREMIUM_FACTOR = 1.055; 

    // DOM Elements
    const usdInput = document.getElementById('usdInr');
    const usdRange = document.getElementById('usdInrRange');
    const silverInput = document.getElementById('silverPrice');
    const silverRange = document.getElementById('silverPriceRange');
    const priceDisplay = document.getElementById('calculatedPrice');
    const daysRange = document.getElementById('daysRange');
    const daysDisplay = document.getElementById('daysDisplay');
    const ctx = document.getElementById('silverChart').getContext('2d');
    const statusBadge = document.getElementById('apiStatus');
    const sourceText = document.getElementById('sourceText');

    let myChart;
    let currentView = 'etf'; 
    let daysToShow = 14;

    // --- LIVE FETCHING ENGINE ---
    async function fetchMarketData() {
        statusBadge.innerText = "Connecting...";
        statusBadge.className = "status-badge";
        sourceText.innerText = "Contacting market data...";

        let usdSuccess = false;
        let chartSuccess = false;

        // 1. Fetch Live USD/INR (Frankfurter - Reliable)
        try {
            const usdRes = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR');
            const usdData = await usdRes.json();
            if (usdData && usdData.rates && usdData.rates.INR) {
                const rate = usdData.rates.INR;
                usdInput.value = rate.toFixed(2);
                usdRange.value = rate.toFixed(2);
                usdSuccess = true;
            }
        } catch (e) {
            console.warn("USD Fetch failed:", e);
        }

        // 2. Fetch History (Yahoo via Proxy - Flaky but rich data)
        const PROXY_URL = "https://api.allorigins.win/raw?url=";
        const timestamp = new Date().getTime(); // Cache buster
        
        const urls = {
            etf: `${PROXY_URL}${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/SILVERIETF.NS?interval=1d&range=1mo&_=' + timestamp)}`,
            silver: `${PROXY_URL}${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/XAGUSD=X?interval=1d&range=1mo&_=' + timestamp)}`,
            usd: `${PROXY_URL}${encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/INR=X?interval=1d&range=1mo&_=' + timestamp)}`
        };

        try {
            const [etfRes, silverRes, usdChartRes] = await Promise.all([
                fetch(urls.etf).then(r => r.json()),
                fetch(urls.silver).then(r => r.json()),
                fetch(urls.usd).then(r => r.json())
            ]);

             // Processor Helper
             const processChart = (data) => {
                if(!data.chart || !data.chart.result || !data.chart.result[0]) return null;
                const res = data.chart.result[0];
                const quotes = res.indicators.quote[0].close;
                const timestamps = res.timestamp;
                
                const cleanData = [];
                const cleanDates = [];
                
                for(let i=0; i<quotes.length; i++) {
                    if(quotes[i] != null && timestamps[i] != null) {
                        cleanData.push(quotes[i]);
                        const date = new Date(timestamps[i] * 1000);
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = date.toLocaleString('default', { month: 'short' });
                        cleanDates.push(`${month} ${day}`);
                    }
                }
                return { prices: cleanData, dates: cleanDates };
             };

             const etfClean = processChart(etfRes);
             const silverClean = processChart(silverRes);
             const usdClean = processChart(usdChartRes);

             if (etfClean && silverClean && usdClean) {
                 fullHistory.dates = etfClean.dates;
                 fullHistory.etf = etfClean.prices.map(p => parseFloat(p.toFixed(2)));
                 const len = fullHistory.dates.length;
                 fullHistory.silver = silverClean.prices.slice(-len).map(p => parseFloat(p.toFixed(2)));
                 fullHistory.usd = usdClean.prices.slice(-len).map(p => parseFloat(p.toFixed(2)));
                 
                 // If we have live chart data, update inputs to the very latest close
                 const lastSilver = fullHistory.silver[fullHistory.silver.length - 1];
                 silverInput.value = lastSilver;
                 silverRange.value = lastSilver;
                 
                 // If USD fetch failed earlier, use the chart's last close
                 if (!usdSuccess) {
                     const lastUsd = fullHistory.usd[fullHistory.usd.length - 1];
                     usdInput.value = lastUsd;
                     usdRange.value = lastUsd;
                 }
                 
                 chartSuccess = true;
             }
        } catch (e) {
            console.warn("Chart Fetch failed:", e);
        }

        // 3. Update Status UI
        if (usdSuccess && chartSuccess) {
            statusBadge.innerText = "Live";
            statusBadge.className = "status-badge live";
            sourceText.innerText = "Data sourced from Yahoo & Frankfurter";
        } else if (usdSuccess) {
            statusBadge.innerText = "USD Live";
            statusBadge.className = "status-badge partial";
            sourceText.innerText = "USD Live. Graph using saved history.";
        } else if (chartSuccess) {
             statusBadge.innerText = "Live";
             statusBadge.className = "status-badge live";
             sourceText.innerText = "Data sourced from Yahoo Finance";
        } else {
            statusBadge.innerText = "Offline";
            statusBadge.className = "status-badge error";
            sourceText.innerText = "Fetch failed. Using saved data.";
        }

        calculateETF();
        updateChartDataset(currentView);
    }

    // --- Charting Logic ---
    function getSlicedData() {
        const start = Math.max(0, fullHistory.dates.length - daysToShow);
        return {
            dates: fullHistory.dates.slice(start),
            etf: fullHistory.etf.slice(start),
            silver: fullHistory.silver.slice(start),
            usd: fullHistory.usd.slice(start)
        };
    }

    function initChart() {
        const sliced = getSlicedData();
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(192, 57, 43, 0.2)');
        gradient.addColorStop(1, 'rgba(192, 57, 43, 0.0)');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sliced.dates,
                datasets: [{
                    label: 'ICICI Silver ETF Price (₹)',
                    data: sliced.etf,
                    borderColor: '#c0392b',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#c0392b',
                    pointRadius: 4,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    if(currentView === 'silver') return `Silver: $${context.parsed.y}`;
                                    return `Price: ₹${context.parsed.y}`;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: false, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- Calculation Logic ---
    function calculateETF() {
        const usd = parseFloat(usdInput.value);
        const silver = parseFloat(silverInput.value);
        const pricePerKgInr = silver * OZ_TO_KG * usd;
        const pricePerGramInr = pricePerKgInr / KG_TO_GRAM;
        const finalPrice = pricePerGramInr * PREMIUM_FACTOR;

        priceDisplay.textContent = "₹" + finalPrice.toFixed(2);
        if(currentView === 'etf') updateChartProjection(finalPrice);
    }

    // --- Sync Inputs ---
    function syncInputs(source, target) {
        target.value = source.value;
        calculateETF();
    }

    usdInput.addEventListener('input', () => syncInputs(usdInput, usdRange));
    usdRange.addEventListener('input', () => syncInputs(usdRange, usdInput));
    silverInput.addEventListener('input', () => syncInputs(silverInput, silverRange));
    silverRange.addEventListener('input', () => syncInputs(silverRange, silverInput));

    // --- History Range Control ---
    daysRange.addEventListener('input', (e) => {
        daysToShow = parseInt(e.target.value);
        daysDisplay.textContent = daysToShow + " Days";
        updateChartDataset(currentView); 
    });

    // --- Chart Management ---
    function updateChartDataset(view) {
        currentView = view;
        document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
        if(event && event.target) event.target.classList.add('active');
        else document.querySelector(`.btn[onclick*="${view}"]`)?.classList.add('active');

        const sliced = getSlicedData();
        let label, data, color;

        if (view === 'etf') {
            label = 'ICICI Silver ETF Price (₹)';
            data = [...sliced.etf];
            color = '#c0392b'; 
        } else if (view === 'silver') {
            label = "International Silver Price ($/oz)";
            data = [...sliced.silver];
            color = '#7f8c8d'; 
        } else if (view === 'usd') {
            label = "USD to INR Rate (₹)";
            data = [...sliced.usd];
            color = '#27ae60'; 
        }

        myChart.data.labels = [...sliced.dates];
        myChart.data.datasets[0].label = label;
        myChart.data.datasets[0].data = data;
        myChart.data.datasets[0].borderColor = color;
        myChart.data.datasets[0].pointBorderColor = color;
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, hexToRgba(color, 0.2));
        gradient.addColorStop(1, hexToRgba(color, 0.0));
        myChart.data.datasets[0].backgroundColor = gradient;

        myChart.data.datasets[0].pointBackgroundColor = '#fff';
        delete myChart.data.datasets[0].segment; 

        myChart.update();

        if (view === 'etf') calculateETF();
    }

    function updateChartProjection(predictedPrice) {
        if (currentView !== 'etf') return;
        const sliced = getSlicedData();
        const newLabels = [...sliced.dates, "Forecast"];
        const newData = [...sliced.etf, predictedPrice];

        myChart.data.labels = newLabels;
        myChart.data.datasets[0].data = newData;
        
        const pointColors = new Array(sliced.etf.length).fill(myChart.data.datasets[0].borderColor);
        pointColors.push('#2980b9'); 
        
        myChart.data.datasets[0].pointBorderColor = pointColors;
        myChart.data.datasets[0].pointBackgroundColor = pointColors.map((c, i) => i === pointColors.length - 1 ? '#2980b9' : '#fff');
        
        myChart.data.datasets[0].segment = {
            borderDash: ctx => ctx.p0DataIndex === sliced.etf.length - 1 ? [6, 6] : undefined
        };

        myChart.update();
    }

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Initialize
    initChart();
    calculateETF();
    // Start Fetch
    setTimeout(fetchMarketData, 500);

</script>

</body>
</html>
